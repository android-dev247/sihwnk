<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termux Chat Server</title>
    <style>
        * {margin:0;padding:0;box-sizing:border-box;}
        body {font-family:monospace;background:#000;color:#0f0;padding:20px;}
        .chat-box {max-width:800px;margin:0 auto;border:1px solid #0f0;height:80vh;display:flex;flex-direction:column;}
        .messages {flex:1;padding:10px;overflow-y:auto;border-bottom:1px solid #0f0;}
        .message {margin:5px 0;padding:8px;background:#111;border-radius:4px;}
        .self {text-align:right;background:#1a1a1a;}
        .input-area {display:flex;padding:10px;}
        #msg-input {flex:1;background:#111;border:1px solid #0f0;color:#0f0;padding:8px;outline:none;}
        #send-btn {background:#0f0;color:#000;border:none;padding:8px 16px;margin-left:5px;cursor:pointer;}
        .status {padding:5px;text-align:center;color:#ff0;font-size:12px;}
    </style>
</head>
<body>
    <div class="chat-box">
        <div class="status" id="status">Connecting...</div>
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <input type="text" id="msg-input" placeholder="Type message...">
            <button id="send-btn">Send</button>
        </div>
    </div>

    <script>
        const STATUS = document.getElementById('status');
        const MESSAGES = document.getElementById('messages');
        const INPUT = document.getElementById('msg-input');
        const SEND_BTN = document.getElementById('send-btn');

        let WS;
        let SERVER_URL = window.location.hostname === 'android-dev247.github.io' 
            ? prompt('Enter Server WS URL (e.g., wss://xxx.ngrok.io)') 
            : `ws://${window.location.host}`;

        function initWS() {
            WS = new WebSocket(SERVER_URL);
            WS.onopen = () => {
                STATUS.textContent = 'Connected to Termux Server';
                SEND_BTN.disabled = false;
                loadHistory();
            };
            WS.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                addMessage(msg.content, msg.sender !== 'self', msg.timestamp);
            };
            WS.onclose = () => {
                STATUS.textContent = 'Disconnected, retrying...';
                SEND_BTN.disabled = true;
                setTimeout(initWS, 3000);
            };
            WS.onerror = (err) => {
                STATUS.textContent = 'Error: ' + err.message;
            };
        }

        async function loadHistory() {
            try {
                const API_URL = SERVER_URL.replace('ws', 'http').replace('wss', 'https');
                const res = await fetch(`${API_URL}/messages`);
                const msgs = await res.json();
                msgs.forEach(msg => addMessage(msg.content, msg.sender !== 'self', msg.timestamp));
            } catch (e) {console.log('Load history failed:', e);}
        }

        function addMessage(content, isOther, time) {
            const div = document.createElement('div');
            div.className = `message ${isOther ? '' : 'self'}`;
            div.innerHTML = `<span>${content}</span><br><small>${new Date(time).toLocaleTimeString()}</small>`;
            MESSAGES.appendChild(div);
            MESSAGES.scrollTop = MESSAGES.scrollHeight;
        }

        SEND_BTN.addEventListener('click', () => {
            const content = INPUT.value.trim();
            if (!content || WS.readyState !== WebSocket.OPEN) return;
            const msg = {sender: 'self', content, timestamp: new Date().toISOString()};
            WS.send(JSON.stringify(msg));
            INPUT.value = '';
        });

        INPUT.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') SEND_BTN.click();
        });

        initWS();
    </script>
</body>
</html>
